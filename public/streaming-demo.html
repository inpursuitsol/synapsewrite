<script>
  const startBtn = document.getElementById("startBtn");
  const out = document.getElementById("out");
  const status = document.getElementById("status");
  const promptEl = document.getElementById("prompt");

  function tryParseJSON(str) {
    try { return JSON.parse(str); } catch { return null; }
  }

  startBtn.addEventListener("click", async () => {
    out.textContent = "";
    status.textContent = "Connecting...";
    startBtn.disabled = true;

    // Provide a sensible default if user left prompt empty
    const promptValue = (promptEl.value || "").trim() || 
      "Write a 200-word helpful blog post on how early-stage startups can adopt AI quickly and ethically.";

    try {
      const resp = await fetch("/api/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: promptValue }),
      });

      if (!resp.ok) {
        out.textContent = "Server error: " + (await resp.text());
        status.textContent = "Error";
        startBtn.disabled = false;
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder("utf-8");

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });

        chunk
          .split("\n")
          .filter((line) => line.startsWith("data:"))
          .forEach((line) => {
            const data = line.replace(/^data:\s*/, "");
            if (data === "[DONE]") {
              status.textContent = "Finished";
              startBtn.disabled = false;
              return;
            }
            const parsed = tryParseJSON(data);
            if (parsed?.text) {
              out.textContent += parsed.text;
            }
          });
      }

      status.textContent = "Finished";
    } catch (err) {
      out.textContent = "Request failed: " + err;
      status.textContent = "Error";
    } finally {
      startBtn.disabled = false;
    }
  });
</script>
