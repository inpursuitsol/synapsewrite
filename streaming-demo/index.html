<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Streaming Article Generator — Export to WordPress</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; max-width:900px; margin:28px auto; padding:18px; background:#fafafa; }
    h1 { font-size:20px; margin-bottom:8px; }
    .controls, .export-bar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    button { padding:8px 14px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer; font-size:14px; }
    button.primary { background:#0b6cff; color:white; border-color:#0b6cff; }
    #status { margin-bottom:8px; color:#444; }
    #output { border:1px solid #eee; padding:14px; min-height:180px; white-space:pre-wrap; background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <h1>Streaming Article Generator</h1>

  <div class="controls">
    <button id="writeBtn" class="primary">Write Article</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="regenerateBtn" disabled>Regenerate</button>
  </div>

  <div id="status">Idle</div>
  <div id="output"></div>

  <div class="export-bar" style="margin-top:14px;">
    <button id="copyBtn">Copy to Clipboard</button>
    <button id="downloadBtn">Download .md</button>
    <button id="exportBtn">Export to WordPress</button>
  </div>

<script>
(() => {
  // Simulated paragraphs (replace with real stream later)
  const paras = [
    "# The future of remote work\n\n",
    "Remote work has transformed how companies operate...",
    "Employees value flexibility, and employers can access global talent pools...",
    "Productivity tools and async communication have matured...",
    "However, companies face new challenges: onboarding remotely, measuring outcomes...",
    "Hybrid models are emerging as a popular compromise...",
    "Ultimately, remote work is a long-term evolution."
  ];

  let index = 0, running=false, paused=false, timer=null;
  const speed = 900;

  const writeBtn = document.getElementById('writeBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const regenBtn = document.getElementById('regenerateBtn');
  const status = document.getElementById('status');
  const output = document.getElementById('output');

  function updateStatus() {
    if (!running && index === 0) return status.textContent = 'Idle';
    if (running && !paused) return status.textContent = `Generating — ${index}/${paras.length} paragraphs`;
    if (paused) return status.textContent = `Paused — ${index}/${paras.length} paragraphs`;
    status.textContent = `Finished — ${index}/${paras.length} paragraphs`;
  }

  function showSkeleton() {
    output.innerHTML = '';
    for (let i=0;i<5;i++){
      const s = document.createElement('div');
      s.style.height = '12px';
      s.style.margin = '8px 0';
      s.style.background = 'linear-gradient(90deg,#eee,#f5f5f5,#eee)';
      s.style.borderRadius = '6px';
      output.appendChild(s);
    }
  }

  function appendChunk(text) {
    const node = document.createElement('div');
    node.textContent = text + '\n\n';
    output.appendChild(node);
    window.scrollTo(0,document.body.scrollHeight);
  }

  function startStream() {
    if (running) return;
    running=true; paused=false; index=0;
    output.innerHTML=''; showSkeleton(); updateStatus();
    pauseBtn.disabled=false; regenBtn.disabled=true;
    setTimeout(()=>{ output.innerHTML=''; pump(); }, 350);
  }

  function pump() {
    updateStatus();
    if (index >= paras.length) {
      running=false; paused=false; updateStatus();
      pauseBtn.disabled=true; regenBtn.disabled=false;
      return;
    }
    if (paused) return;
    appendChunk(paras[index]); index++;
    timer = setTimeout(pump, speed + Math.random()*350);
  }

  function pauseResume() {
    if (!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? 'Resume' : 'Pause';
    if (!paused) pump();
    updateStatus();
  }

  function regenerate() {
    clearTimeout(timer);
    running=false; paused=false; index=0; output.innerHTML='';
    pauseBtn.disabled=true; regenBtn.disabled=true;
    startStream();
  }

  writeBtn.addEventListener('click', ()=>{ startStream(); pauseBtn.textContent='Pause'; });
  pauseBtn.addEventListener('click', pauseResume);
  regenBtn.addEventListener('click', regenerate);

  // Export helpers
  document.getElementById('copyBtn').addEventListener('click', async ()=> {
    try {
      await navigator.clipboard.writeText(output.innerText || '');
      alert('✅ Copied to clipboard');
    } catch(e){ alert('Copy failed: ' + e.message); }
  });
  document.getElementById('downloadBtn').addEventListener('click', ()=> {
    const text = output.innerText || '';
    const blob = new Blob([text], {type:'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='article.md'; a.click(); URL.revokeObjectURL(url);
  });

  // Export to WordPress
  document.getElementById('exportBtn').addEventListener('click', async ()=> {
    const title = prompt('Post title (what should we call this draft?)', 'My Streamed Article');
    if (!title) return alert('Export canceled: title required.');

    const content = output.innerHTML || '<p>(empty)</p>'; // HTML content to send to WP
    try {
      const res = await fetch('http://localhost:3000/exportToWP', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ title, content })
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error(data);
        return alert('Export failed: ' + (data.error || JSON.stringify(data)));
      }
      if (data.editUrl) {
        if (confirm('✅ Draft created. Open draft in WordPress?')) {
          window.open(data.editUrl, '_blank');
        } else {
          alert('Draft created: ' + data.editUrl);
        }
      } else {
        alert('Draft created (post id: ' + data.postId + ')');
      }
    } catch (err) {
      console.error(err);
      alert('Export failed: ' + err.message);
    }
  });

  updateStatus();
})();
</script>
</body>
</html>
